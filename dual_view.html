<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<title>GPX Comparison Viewer1</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin:0;
  font-family:sans-serif;
  overflow:hidden;
  background:#f4f4f4;
}

/* Map area */
#map {
  height:60vh;
  width:100%;
  display:block;
}

/* Top upload bar */
#topbar {
  padding:8px;
  background:white;
  box-shadow:0 2px 8px rgba(0,0,0,0.2);
  display:flex;
  gap:10px;
  align-items:center;
}

/* Bottom controls */
#controls {
  position:fixed;
  bottom:0;
  width:100%;
  background:white;
  padding:6px 0;
  text-align:center;
  box-shadow:0 -2px 8px rgba(0,0,0,0.3);
}

button {
  margin:4px;
  padding:5px 12px;
  font-size:14px;
  cursor:pointer;
}

.route {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  margin:4px 0;
}

.route-name {
  width:220px;
  text-overflow:ellipsis;
  white-space:nowrap;
  overflow:hidden;
  text-align:right;
  font-weight:bold;
}

input[type=file] {
  font-size:14px;
}

input[type=range] {
  width:55%;
  vertical-align:middle;
}

.chart-container {
  width:80%;
  margin:4px auto;
  height:80px;
}

.active-speed {
  background:#007BFF;
  color:white;
}

.individual-play {
  min-width:40px;
}

.stopwatch {
  font-family: 'Courier New', monospace;
  font-size: 16px;
  font-weight: bold;
  min-width: 60px;
  display: inline-block;
  text-align: center;
}

/* Help Modal */
#helpOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 999;
}

#helpContent {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: white;
  padding: 30px 40px;
  border-radius: 8px;
  max-width: 700px;
  max-height: 90vh;
  overflow-y: auto;
  z-index: 1000;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

#helpContent h2 {
  margin-top: 0;
  color: #333;
}

#helpContent ol {
  text-align: left;
  line-height: 1.8;
  padding-left: 20px;
}

#helpContent ol li {
  margin-bottom: 10px;
}

#closeHelp {
  position: absolute;
  top: 15px;
  right: 15px;
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: #999;
  padding: 0;
  width: 30px;
  height: 30px;
  line-height: 1;
}

#closeHelp:hover {
  color: #333;
}

</style>
</head>

<body>
<!-- Upload UI -->
<div id="topbar">
  <input type="file" id="file1" accept=".gpx">
  <input type="file" id="file2" accept=".gpx">
  <button id="loadBtn">Load GPX</button>
  <button id="helpBtn">How to Download GPX</button>
</div>

<div id="map"></div>

<!-- Controls -->
<div id="controls" style="display:none;">
  <div style="margin-bottom:6px;">
    <button id="playBoth">▶ Play Both</button>
    <button class="speed" data-speed="1">×1</button>
    <button class="speed" data-speed="2">×2</button>
    <button class="speed" data-speed="4">×4</button>
    <button class="speed" data-speed="8">×8</button>
    <button class="speed" data-speed="12">×12</button>
  </div>

  <div class="route">
    <span id="name1" class="route-name" style="color:blue;"></span>
    <input type="range" id="slider1" min="0" value="0">
    <button id="play1" class="individual-play">▶</button>
    <span id="stopwatch1" class="stopwatch">00:00</span>
  </div>
  <div class="chart-container"><canvas id="chart1"></canvas></div>

  <div class="route">
    <span id="name2" class="route-name" style="color:red;"></span>
    <input type="range" id="slider2" min="0" value="0">
    <button id="play2" class="individual-play">▶</button>
    <span id="stopwatch2" class="stopwatch">00:00</span>
  </div>
  <div class="chart-container"><canvas id="chart2"></canvas></div>
</div>

<script>
window.addEventListener("load", function() {
  console.log("CHECK:", document.body.children.length);
  if (window.__GPX_LOADED__) {
      console.warn("Script attempted to run twice — aborting second run.");
      return;
  }
  window.__GPX_LOADED__ = true;
  
  console.log("SCRIPT EXECUTED");

// ---------------------- FILE READING -----------------------
function readFile(f) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = e => resolve(e.target.result);
    r.onerror = reject;
    r.readAsText(f);
  });
}

// --------------------- GPX PARSER --------------------------
function parseGPX(text) {
  const xml = new DOMParser().parseFromString(text, "text/xml");
  const pts = [];
  const nodes = xml.getElementsByTagName("trkpt");

  for (let n of nodes) {
    const lat = parseFloat(n.getAttribute("lat"));
    const lon = parseFloat(n.getAttribute("lon"));

    const eleNode = n.getElementsByTagName("ele")[0];
    const ele = eleNode ? parseFloat(eleNode.textContent) * 3.28084 : 0;

    const tNode = n.getElementsByTagName("time")[0];
    let time = "";
    let timestamp = null;
    if (tNode && tNode.textContent) {
      timestamp = new Date(tNode.textContent);
      if (!isNaN(timestamp)) {
        let dt = new Date(timestamp.getTime() - 8 * 3600 * 1000);
        time = dt.toLocaleTimeString();
      }
    }

    pts.push({ lat, lon, ele, time, timestamp });
  }
  return pts;
}

// --------------- MATH HELPERS -----------------
function bounds(arr) {
  if (!arr.length) return [0, 1];
  const mn = Math.min(...arr);
  const mx = Math.max(...arr);
  const rg = mx - mn || 1;
  return [mn - 0.05 * rg, mx + 0.05 * rg];
}

// --------------- GLOBALS -----------------
let coords1 = [], coords2 = [], elev1 = [], elev2 = [], time1 = [], time2 = [];
let timestamps1 = [], timestamps2 = []; // Raw Date objects
let marker1 = null, marker2 = null, c1 = null, c2 = null;
let speedMult = 1;
let playing = false, timer = null;
let playing1 = false, playing2 = false, timer1 = null, timer2 = null;
let stopwatch1Start = null, stopwatch2Start = null; // null means not started
let map = null;

// ---------------------- MAIN LOAD -----------------------
const loadBtn = document.getElementById("loadBtn");
loadBtn.onclick = async () => {
  const f1 = document.getElementById("file1").files[0];
  const f2 = document.getElementById("file2").files[0];
  if (!f1 || !f2) {
    alert("Select both GPX files");
    return;
  }

  const g1 = parseGPX(await readFile(f1));
  const g2 = parseGPX(await readFile(f2));

  if (!g1.length || !g2.length) {
    alert("One of the GPX files is empty or invalid");
    return;
  }

  coords1 = g1.map(p => [p.lat, p.lon]);
  coords2 = g2.map(p => [p.lat, p.lon]);
  elev1 = g1.map(p => p.ele);
  elev2 = g2.map(p => p.ele);
  time1 = g1.map(p => p.time);
  time2 = g2.map(p => p.time);
  timestamps1 = g1.map(p => p.timestamp);
  timestamps2 = g2.map(p => p.timestamp);

  document.getElementById("name1").textContent = f1.name;
  document.getElementById("name2").textContent = f2.name;

  document.getElementById("controls").style.display = "block";

  setupMap();
  setupCharts();
  setupSliders();
};

// ---------------------- HELP MODAL -----------------------
const helpBtn = document.getElementById("helpBtn");
const helpModal = document.getElementById("helpModal");
const closeHelp = document.getElementById("closeHelp");
const helpOverlay = document.getElementById("helpOverlay");

helpBtn.onclick = () => {
  helpModal.style.display = "block";
};

closeHelp.onclick = () => {
  helpModal.style.display = "none";
};

helpOverlay.onclick = () => {
  helpModal.style.display = "none";
};

// ---------------------- HELP MODAL -----------------------
function setupHelpModal() {
  document.getElementById("helpBtn").onclick = () => {
    document.getElementById("helpModal").style.display = "block";
  };

  document.getElementById("closeHelp").onclick = () => {
    document.getElementById("helpModal").style.display = "none";
  };

  document.getElementById("helpOverlay").onclick = () => {
    document.getElementById("helpModal").style.display = "none";
  };
}

// ---------------------- MAP -----------------------
function setupMap() {
  if (map) {
    map.remove();
    map = null;
  }

  setTimeout(() => {
    map = L.map('map').setView(coords1[0], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom:19
    }).addTo(map);

    L.polyline(coords1, {color:'blue', weight:3}).addTo(map);
    L.polyline(coords2, {color:'red', weight:3}).addTo(map);

    marker1 = L.marker(coords1[0], {icon:makeIcon('blue')}).addTo(map);
    marker2 = L.marker(coords2[0], {icon:makeIcon('red')}).addTo(map);

    const allCoords = [...coords1, ...coords2];
    map.fitBounds(allCoords);
  }, 100);
}

function makeIcon(color){
  return L.icon({
    iconUrl:"data:image/svg+xml;utf8,"+
      `<svg xmlns='http://www.w3.org/2000/svg' width='24' height='24'>
        <circle cx='12' cy='12' r='8' fill='${color}' stroke='black' stroke-width='1'/>
      </svg>`,
    iconSize:[20,20],
    iconAnchor:[10,10]
  });
}

// ---------------------- CHARTS -----------------------
function setupCharts() {
  const [y1mn, y1mx] = bounds(elev1);
  const [y2mn, y2mx] = bounds(elev2);

  if (c1) c1.destroy();
  if (c2) c2.destroy();

  c1 = makeChart("chart1", elev1, time1, "blue", y1mn, y1mx);
  c2 = makeChart("chart2", elev2, time2, "red", y2mn, y2mx);
}

function makeChart(id, elev, time, color, ymin, ymax) {
  const ctx = document.getElementById(id).getContext('2d');
  
  const persistentMarker = {
    id: 'persistentMarker',
    currentIndex: 0,
    afterDatasetsDraw(chart) {
      const {ctx, chartArea: {top, bottom}, scales: {x, y}} = chart;
      const idx = this.currentIndex;
      
      if (idx >= 0 && idx < elev.length) {
        const xPos = x.getPixelForValue(idx);
        const yPos = y.getPixelForValue(elev[idx]);
        
        // Draw vertical line
        ctx.save();
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo(xPos, top);
        ctx.lineTo(xPos, bottom);
        ctx.stroke();
        ctx.setLineDash([]);
        
        // Draw circle at point
        ctx.fillStyle = color;
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(xPos, yPos, 5, 0, 2 * Math.PI);
        ctx.fill();
        ctx.stroke();
        
        // Draw label box
        const label = `${elev[idx].toFixed(0)} ft | ${time[idx]}`;
        ctx.font = '12px sans-serif';
        const textWidth = ctx.measureText(label).width;
        const boxX = xPos + 10;
        const boxY = yPos - 20;
        const padding = 4;
        
        ctx.fillStyle = 'rgba(0,0,0,0.8)';
        ctx.fillRect(boxX, boxY, textWidth + padding * 2, 20);
        ctx.fillStyle = 'white';
        ctx.fillText(label, boxX + padding, boxY + 14);
        
        ctx.restore();
      }
    }
  };
  
  return new Chart(ctx, {
    type: 'line',
    data: {
      labels: elev.map((_,i)=>i),
      datasets: [{
        label:'Elevation (ft)',
        data:elev,
        borderColor:color,
        borderWidth:2,
        fill:false,
        pointRadius:0
      }]
    },
    options:{
      animation:false,
      maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        tooltip:{
          enabled: true,
          mode: 'index',
          intersect: false,
          callbacks:{
            title:()=>null,
            label:c=>`Elevation: ${c.formattedValue} ft | Time: ${time[c.dataIndex]}`
          }
        }
      },
      scales:{
        x:{display:false},
        y:{min:ymin, max:ymax, ticks:{callback:v=>v.toFixed(0)}}
      }
    },
    plugins: [persistentMarker]
  });
}

function updateCursor(chart, idx){
  chart.config.plugins[0].currentIndex = idx;
  chart.update();
}

// ---------------------- SLIDERS -----------------------
function setupSliders() {
  const s1 = document.getElementById("slider1");
  const s2 = document.getElementById("slider2");

  s1.max = coords1.length - 1;
  s2.max = coords2.length - 1;

  s1.oninput = () => {
    const i = +s1.value;
    marker1.setLatLng(coords1[i]);
    updateCursor(c1, i);
    if (stopwatch1Start !== null && !playing1) {
      updateStopwatchDisplay(1, i);
    }
  };

  s2.oninput = () => {
    const i = +s2.value;
    marker2.setLatLng(coords2[i]);
    updateCursor(c2, i);
    if (stopwatch2Start !== null && !playing2) {
      updateStopwatchDisplay(2, i);
    }
  };

  setupPlayback();
  setupIndividualPlayback();
}

// ---------------------- PLAYBACK -----------------------
function setupPlayback() {
  const playBtn = document.getElementById("playBoth");

  playBtn.onclick = () => {
    if (playing) {
      playing = false;
      playBtn.textContent = "▶ Play Both";
      clearInterval(timer);
    } else {
      // Stop individual playbacks
      if (playing1) {
        playing1 = false;
        clearInterval(timer1);
        document.getElementById("play1").textContent = "▶";
      }
      if (playing2) {
        playing2 = false;
        clearInterval(timer2);
        document.getElementById("play2").textContent = "▶";
      }
      
      playing = true;
      playBtn.textContent = "⏸ Pause Both";
      startPlayback();
    }
  };

  document.querySelectorAll('.speed').forEach(b => {
    b.onclick = () => {
      document.querySelectorAll('.speed').forEach(x => x.classList.remove("active-speed"));
      b.classList.add("active-speed");
      speedMult = parseFloat(b.dataset.speed);

      if (playing) {
        clearInterval(timer);
        startPlayback();
      }
      if (playing1) {
        clearInterval(timer1);
        startIndividualPlayback(1);
      }
      if (playing2) {
        clearInterval(timer2);
        startIndividualPlayback(2);
      }
    };
  });
}
}

function startPlayback() {
  const s1 = document.getElementById("slider1");
  const s2 = document.getElementById("slider2");
  const playBtn = document.getElementById("playBoth");

  timer = setInterval(() => {
    let i1 = +s1.value;
    let i2 = +s2.value;

    let done1 = false, done2 = false;

    if (i1 < coords1.length - 1) {
      i1++;
      s1.value = i1;
      marker1.setLatLng(coords1[i1]);
      updateCursor(c1, i1);
    } else {
      done1 = true;
    }

    if (i2 < coords2.length - 1) {
      i2++;
      s2.value = i2;
      marker2.setLatLng(coords2[i2]);
      updateCursor(c2, i2);
    } else {
      done2 = true;
    }

    if (done1 && done2) {
      clearInterval(timer);
      playing = false;
      playBtn.textContent = "▶ Play Both";
    }

  }, 100 / speedMult);
}

// ---------------------- INDIVIDUAL PLAYBACK -----------------------
function setupIndividualPlayback() {
  const play1Btn = document.getElementById("play1");
  const play2Btn = document.getElementById("play2");

  play1Btn.onclick = () => {
    if (playing1) {
      playing1 = false;
      play1Btn.textContent = "▶";
      clearInterval(timer1);
    } else {
      // Stop "Play Both" if active
      if (playing) {
        playing = false;
        clearInterval(timer);
        document.getElementById("playBoth").textContent = "▶ Play Both";
      }
      
      playing1 = true;
      play1Btn.textContent = "⏸";
      const currentIndex = +document.getElementById("slider1").value;
      stopwatch1Start = currentIndex;
      startIndividualPlayback(1);
    }
  };

  play2Btn.onclick = () => {
    if (playing2) {
      playing2 = false;
      play2Btn.textContent = "▶";
      clearInterval(timer2);
    } else {
      // Stop "Play Both" if active
      if (playing) {
        playing = false;
        clearInterval(timer);
        document.getElementById("playBoth").textContent = "▶ Play Both";
      }
      
      playing2 = true;
      play2Btn.textContent = "⏸";
      const currentIndex = +document.getElementById("slider2").value;
      stopwatch2Start = currentIndex;
      startIndividualPlayback(2);
    }
  };
}

function startIndividualPlayback(routeNum) {
  const slider = document.getElementById(`slider${routeNum}`);
  const coords = routeNum === 1 ? coords1 : coords2;
  const marker = routeNum === 1 ? marker1 : marker2;
  const chart = routeNum === 1 ? c1 : c2;
  const playBtn = document.getElementById(`play${routeNum}`);
  
  const timerVar = setInterval(() => {
    let i = +slider.value;
    
    if (i < coords.length - 1) {
      i++;
      slider.value = i;
      marker.setLatLng(coords[i]);
      updateCursor(chart, i);
      updateStopwatchDisplay(routeNum, i);
    } else {
      clearInterval(timerVar);
      if (routeNum === 1) {
        playing1 = false;
      } else {
        playing2 = false;
      }
      playBtn.textContent = "▶";
    }
  }, 100 / speedMult);
  
  if (routeNum === 1) {
    timer1 = timerVar;
  } else {
    timer2 = timerVar;
  }
}

// ---------------------- STOPWATCH -----------------------
function formatTime(milliseconds) {
  const totalSeconds = Math.floor(milliseconds / 1000);
  const minutes = Math.floor(totalSeconds / 60);
  const seconds = totalSeconds % 60;
  return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function updateStopwatchDisplay(routeNum, currentIndex) {
  const timestamps = routeNum === 1 ? timestamps1 : timestamps2;
  const startIndex = routeNum === 1 ? stopwatch1Start : stopwatch2Start;
  
  // If stopwatch hasn't been started, show 00:00
  if (startIndex === null || !timestamps[startIndex] || !timestamps[currentIndex]) {
    document.getElementById(`stopwatch${routeNum}`).textContent = "00:00";
    return;
  }
  
  const startTime = timestamps[startIndex].getTime();
  const currentTime = timestamps[currentIndex].getTime();
  const elapsed = currentTime - startTime;
  
  document.getElementById(`stopwatch${routeNum}`).textContent = formatTime(elapsed);
}
</script>

</body>
</html>
